<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anime Stream</title>
  <style>
    :root {
      --primary-dark: #0a0f3c;
      --primary: #1a237e;
      --primary-light: #283593;
      --accent: #3949ab;
      --text: #e8eaf6;
      --text-secondary: #c5cae9;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--primary-dark);
      color: var(--text);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--accent);
    }
    
    .back-btn {
      display: inline-block;
      padding: 8px 16px;
      background-color: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      margin-right: 20px;
      transition: background-color 0.3s;
    }
    
    .back-btn:hover {
      background-color: var(--primary-light);
    }
    
    h1 {
      margin: 0;
      color: var(--text);
      font-size: 24px;
    }
    
    .video-container {
      width: 100%;
      margin-bottom: 20px;
      background-color: black;
      position: relative;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .server-section, .download-section {
      background-color: var(--primary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    h2, h3 {
      margin-top: 0;
      color: var(--text);
    }
    
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 14px;
      position: relative;
      min-width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover {
      background-color: var(--primary-light);
    }
    
    .btn.active {
      background-color: #5c6bc0;
      box-shadow: 0 0 0 2px #7986cb;
    }
    
    .episodes-section {
      background-color: var(--primary);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .episode-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .episode-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .episode-btn:hover {
      background-color: var(--primary-light);
    }
    
    .episode-btn.active {
      background-color: #5c6bc0;
      box-shadow: 0 0 0 2px #7986cb;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination-btn {
      padding: 8px 12px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: var(--text-secondary);
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.8);
    }
    
    .error-message {
      color: #ff6b6b;
      margin-top: 10px;
    }
    
    .quality-selector {
      margin-top: 10px;
      display: none;
    }
    
    .quality-selector select {
      padding: 8px;
      border-radius: 4px;
      background-color: var(--primary-dark);
      color: var(--text);
      border: 1px solid var(--accent);
      margin-right: 10px;
    }
    
    /* Custom play button */
    .custom-play-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      z-index: 10;
      border: none;
    }
    
    .custom-play-btn:hover {
      background-color: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%) scale(1.1);
    }
    
    .custom-play-btn::after {
      content: '';
      display: block;
      width: 0;
      height: 0;
      border-top: 20px solid transparent;
      border-bottom: 20px solid transparent;
      border-left: 30px solid white;
      margin-left: 5px;
    }
    
    /* Loading spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    .btn .spinner {
      display: none;
    }
    
    .btn.loading .spinner {
      display: block;
    }
    
    .btn.loading span {
      display: none;
    }
    
    /* Video loading animation */
    .video-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    
    .video-loading-bar {
      width: 80%;
      height: 4px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 20px;
    }
    
    .video-loading-progress {
      height: 100%;
      width: 0;
      background-color: var(--accent);
      animation: loading 2s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes loading {
      0% { width: 0; margin-left: 0; }
      50% { width: 100%; margin-left: 0; }
      100% { width: 0; margin-left: 100%; }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="back-btn">‚Üê Back</a>
      <h1 id="anime-title">Loading Anime...</h1>
    </header>
    
    <div class="video-container" id="video-container">
      <div class="video-loading">
        <div class="spinner" style="width: 40px; height: 40px; border-width: 5px;"></div>
        <div>Loading video player...</div>
        <div class="video-loading-bar">
          <div class="video-loading-progress"></div>
        </div>
      </div>
      <button class="custom-play-btn" id="custom-play-btn" style="display: none;"></button>
    </div>
    
    <div class="server-section">
      <h2>Streaming Server</h2>
      <div class="btn-group">
        <button class="btn active" id="animeheaven-btn" onclick="loadAnimeHeaven()">
          <div class="spinner"></div>
          <span>AnimeHeaven</span>
        </button>
        <button class="btn" id="gogoanime-btn" onclick="loadGogoAnime()">
          <div class="spinner"></div>
          <span>GogoAnime</span>
        </button>
      </div>
      <div id="server-error" class="error-message"></div>
    </div>
    
    <div class="download-section">
      <h2>Download Options</h2>
      <div class="btn-group">
        <button class="btn" onclick="downloadFromHeaven()">
          <div class="spinner"></div>
          <span>Download from AnimeHeaven</span>
        </button>
        <button class="btn" onclick="downloadFromTokyo()">
          <div class="spinner"></div>
          <span>Download from TokyoInsider</span>
        </button>
        <button class="btn" onclick="downloadFrom9anime()">
          <div class="spinner"></div>
          <span>Download from 9anime</span>
        </button>
      </div>
      <div id="download-error" class="error-message"></div>
      
      <div class="quality-selector" id="quality-selector">
        <select id="quality-select">
          <option value="">Select quality</option>
        </select>
        <button class="btn" onclick="startDownload()">
          <div class="spinner"></div>
          <span>Download</span>
        </button>
      </div>
    </div>
    
    <div class="episodes-section">
      <h2>Episodes</h2>
      <div class="episode-list" id="episode-list"></div>
      <div class="pagination" id="pagination">
        <button class="pagination-btn" id="prev-page" onclick="prevPage()" disabled>Previous</button>
        <button class="pagination-btn" id="next-page" onclick="nextPage()">Next</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let animeDetails = {};
    let currentServer = 'animeheaven';
    let currentPage = 1;
    const episodesPerPage = 50;
    let currentEpisode = 1;
    let animeId = '';
    let downloadOptions = {};
    let currentIframe = null;
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
      // Parse URL to get anime ID and episode number
      const urlParts = window.location.pathname.split('/');
      animeId = urlParts[2];
      currentEpisode = parseInt(urlParts[3]) || 1;
      
      try {
        // Get anime details from AniList
        animeDetails = await getAnimeDetails();
        document.getElementById('anime-title').textContent = 
          `${animeDetails.title} - Episode ${currentEpisode}`;
        
        // Load default server (AnimeHeaven)
        await loadAnimeHeaven();
        
        // Render episode list
        renderEpisodeList();
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('anime-title').textContent = 'Error loading anime details';
        showError('server-error', 'Failed to load anime details. Please try again later.');
      }
    });
    
    // Get anime details from AniList
    async function getAnimeDetails() {
      const query = `
        query {
          Media(id: ${animeId}, type: ANIME) {
            title { english romaji }
            episodes
          }
        }
      `;
      
      const response = await fetch("https://graphql.anilist.co", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      
      if (!response.ok) {
        throw new Error('Failed to fetch anime details');
      }
      
      const json = await response.json();
      const anime = json.data.Media;
      
      return {
        title: anime.title.english || anime.title.romaji,
        episodes: anime.episodes || 100 // Default to 100 if episodes count is unknown
      };
    }
    
    // Set iframe in video container
    function setIframe(url) {
      const container = document.getElementById('video-container');
      
      // Remove existing iframe if any
      if (currentIframe) {
        container.removeChild(currentIframe);
      }
      
      // Create new iframe
      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.frameBorder = '0';
      iframe.allowFullscreen = true;
      iframe.style.position = 'absolute';
      iframe.style.top = '0';
      iframe.style.left = '0';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      
      // Hide loading elements
      document.querySelector('.video-loading').style.display = 'none';
      document.getElementById('custom-play-btn').style.display = 'none';
      
      container.appendChild(iframe);
      currentIframe = iframe;
    }
    
    // Show error message
    function showError(elementId, message) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      setTimeout(() => element.textContent = '', 5000);
    }
    
    // Show loading state for a button
    function setButtonLoading(buttonId, isLoading) {
      const btn = document.getElementById(buttonId);
      if (isLoading) {
        btn.classList.add('loading');
      } else {
        btn.classList.remove('loading');
      }
    }
    
    // Load AnimeHeaven stream
    async function loadAnimeHeaven() {
      try {
        currentServer = 'animeheaven';
        updateActiveServerButton();
        
        // Show loading state
        document.querySelector('.video-loading').style.display = 'flex';
        document.getElementById('custom-play-btn').style.display = 'none';
        setButtonLoading('animeheaven-btn', true);
        
        const res = await fetch(`https://txtorg-anih.hf.space/video?name=${encodeURIComponent(animeDetails.title)}&episode=${currentEpisode}`);
        
        if (!res.ok) throw new Error('API request failed');
        
        const data = await res.json();
        
        if (!data.videoUrl) throw new Error('No video URL returned');
        
        setIframe(data.videoUrl);
        document.getElementById('server-error').textContent = '';
      } catch (error) {
        console.error('AnimeHeaven error:', error);
        showError('server-error', 'Failed to load AnimeHeaven stream. Trying GogoAnime as fallback...');
        await loadGogoAnime(); // Fallback to GogoAnime
      } finally {
        setButtonLoading('animeheaven-btn', false);
      }
    }
    
    // Load GogoAnime stream
    async function loadGogoAnime() {
      try {
        currentServer = 'gogoanime';
        updateActiveServerButton();
        
        // Show loading state
        document.querySelector('.video-loading').style.display = 'flex';
        document.getElementById('custom-play-btn').style.display = 'none';
        setButtonLoading('gogoanime-btn', true);
        
        // Step 1: Get episode URL
        const res1 = await fetch(`https://reikerxx-animedl.hf.space/anime/${encodeURIComponent(animeDetails.title)}/${currentEpisode}`);
        
        if (!res1.ok) throw new Error('First API request failed');
        
        const data1 = await res1.json();
        
        if (!data1.episodeUrl) throw new Error('No episode URL returned');
        
        // Step 2: Get iframe URL
        const res2 = await fetch(`https://txtorg-anih.hf.space/iframe?url=${encodeURIComponent(data1.episodeUrl)}`);
        
        if (!res2.ok) throw new Error('Second API request failed');
        
        const data2 = await res2.json();
        
        if (!data2.iframeUrl) throw new Error('No iframe URL returned');
        
        // Step 3: Get final video URL
        const res3 = await fetch(`https://txtorg-anih.hf.space/q?q=${encodeURIComponent(data2.iframeUrl)}`);
        
        if (!res3.ok) throw new Error('Third API request failed');
        
        const data3 = await res3.json();
        
        if (!data3.url) throw new Error('No video URL returned');
        
        setIframe(data3.url);
        document.getElementById('server-error').textContent = '';
      } catch (error) {
        console.error('GogoAnime error:', error);
        showError('server-error', 'Failed to load GogoAnime stream. Please try again later.');
        document.querySelector('.video-loading').style.display = 'flex';
        document.getElementById('custom-play-btn').style.display = 'none';
      } finally {
        setButtonLoading('gogoanime-btn', false);
      }
    }
    
    // Update active server button style
    function updateActiveServerButton() {
      document.getElementById('animeheaven-btn').classList.remove('active');
      document.getElementById('gogoanime-btn').classList.remove('active');
      
      if (currentServer === 'animeheaven') {
        document.getElementById('animeheaven-btn').classList.add('active');
      } else {
        document.getElementById('gogoanime-btn').classList.add('active');
      }
    }
    
    // Download from AnimeHeaven
    async function downloadFromHeaven() {
      const btn = event.target.closest('.btn');
      try {
        btn.classList.add('loading');
        
        const res = await fetch(`https://txtorg-anih.hf.space/video?name=${encodeURIComponent(animeDetails.title)}&episode=${currentEpisode}`);
        
        if (!res.ok) throw new Error('API request failed');
        
        const data = await res.json();
        
        if (!data.videoUrl) throw new Error('No video URL returned');
        
        // Create a temporary anchor element to trigger download
        const a = document.createElement('a');
        a.href = data.videoUrl;
        a.download = `${animeDetails.title} - Episode ${currentEpisode}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        document.getElementById('download-error').textContent = '';
      } catch (error) {
        console.error('Download error:', error);
        showError('download-error', 'Failed to prepare download. Please try again.');
      } finally {
        btn.classList.remove('loading');
      }
    }
    
    // Download from TokyoInsider
    async function downloadFromTokyo() {
      const btn = event.target.closest('.btn');
      try {
        btn.classList.add('loading');
        document.getElementById('quality-selector').style.display = 'none';
        document.getElementById('download-error').textContent = '';
        
        const res = await fetch(`https://reaperxxxx-anime.hf.space/api/anime2?name=${encodeURIComponent(animeDetails.title)}&episode=${currentEpisode}`);
        
        if (!res.ok) throw new Error('API request failed');
        
        const data = await res.json();
        
        if (!data.Downloads) throw new Error('No download options available');
        
        // Prepare quality options
        const qualitySelect = document.getElementById('quality-select');
        qualitySelect.innerHTML = '<option value="">Select quality</option>';
        
        // Store download options
        downloadOptions = {};
        
        // Add available qualities
        if (data.Downloads['1080p'] && data.Downloads['1080p'] !== 'Not available') {
          qualitySelect.add(new Option('1080p', '1080p'));
          downloadOptions['1080p'] = data.Downloads['1080p'].url;
        }
        
        if (data.Downloads['720p'] && data.Downloads['720p'] !== 'Not available') {
          qualitySelect.add(new Option('720p', '720p'));
          downloadOptions['720p'] = data.Downloads['720p'].url;
        }
        
        if (data.Downloads['360p'] && data.Downloads['360p'] !== 'Not available') {
          qualitySelect.add(new Option('360p', '360p'));
          downloadOptions['360p'] = data.Downloads['360p'].url;
        }
        
        if (Object.keys(downloadOptions).length === 0) {
          throw new Error('No download options available');
        }
        
        // Show quality selector
        document.getElementById('quality-selector').style.display = 'block';
      } catch (error) {
        console.error('TokyoInsider error:', error);
        showError('download-error', 'No download options available from TokyoInsider for this episode.');
      } finally {
        btn.classList.remove('loading');
      }
    }
    
    // Download from 9anime
    async function downloadFrom9anime() {
      const btn = event.target.closest('.btn');
      try {
        btn.classList.add('loading');
        document.getElementById('quality-selector').style.display = 'none';
        document.getElementById('download-error').textContent = '';
        
        const res = await fetch(`https://txtorg-anih.hf.space/api/anime-download?q=${encodeURIComponent(animeDetails.title)}&episode=${currentEpisode}`);
        
        if (!res.ok) throw new Error('API request failed');
        
        const data = await res.json();
        
        if (!data.success || !data.download_links || data.download_links.length === 0) {
          throw new Error('No download options available');
        }
        
        // Prepare quality options
        const qualitySelect = document.getElementById('quality-select');
        qualitySelect.innerHTML = '<option value="">Select quality</option>';
        
        // Store download options
        downloadOptions = {};
        
        // Add available qualities
        data.download_links.forEach(link => {
          qualitySelect.add(new Option(link.quality, link.quality));
          downloadOptions[link.quality] = link.link;
        });
        
        // Show quality selector
        document.getElementById('quality-selector').style.display = 'block';
      } catch (error) {
        console.error('9anime error:', error);
        showError('download-error', 'No download options available from 9anime for this episode.');
      } finally {
        btn.classList.remove('loading');
      }
    }
    
    // Start download after quality selection
    function startDownload() {
      const btn = event.target.closest('.btn');
      btn.classList.add('loading');
      
      setTimeout(() => {
        const quality = document.getElementById('quality-select').value;
        
        if (!quality || !downloadOptions[quality]) {
          showError('download-error', 'Please select a quality option');
          btn.classList.remove('loading');
          return;
        }
        
        window.open(downloadOptions[quality], '_blank');
        btn.classList.remove('loading');
      }, 500);
    }
    
    // Render episode list with pagination
    function renderEpisodeList() {
      const episodeList = document.getElementById('episode-list');
      episodeList.innerHTML = '';
      
      const totalEpisodes = animeDetails.episodes;
      const startEpisode = (currentPage - 1) * episodesPerPage + 1;
      const endEpisode = Math.min(startEpisode + episodesPerPage - 1, totalEpisodes);
      
      for (let i = startEpisode; i <= endEpisode; i++) {
        const btn = document.createElement('button');
        btn.className = 'episode-btn' + (i === currentEpisode ? ' active' : '');
        btn.textContent = i;
        btn.onclick = () => {
          if (i !== currentEpisode) {
            window.location.href = `/anime/${animeId}/${i}`;
          }
        };
        episodeList.appendChild(btn);
      }
      
      // Update pagination buttons
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = endEpisode >= totalEpisodes;
    }
    
    // Go to previous page
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderEpisodeList();
      }
    }
    
    // Go to next page
    function nextPage() {
      const totalEpisodes = animeDetails.episodes;
      if ((currentPage * episodesPerPage) < totalEpisodes) {
        currentPage++;
        renderEpisodeList();
      }
    }
    
    // Custom play button functionality
    document.getElementById('custom-play-btn').addEventListener('click', function() {
      this.style.display = 'none';
      if (currentServer === 'animeheaven') {
        loadAnimeHeaven();
      } else {
        loadGogoAnime();
      }
    });
  </script>
</body>
</html>
