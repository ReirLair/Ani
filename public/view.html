<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anime Stream</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0a0f3c;
      color: #fff;
    }
    .container {
      max-width: 960px;
      margin: auto;
      padding: 20px;
    }
    video, iframe {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
    }
    button, a.button {
      margin: 10px 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background-color: #1a237e;
      color: white;
      cursor: pointer;
    }
    button:hover, a.button:hover {
      background-color: #283593;
    }
    .episode-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 20px;
    }
    .episode-list button {
      width: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="button">Back</a>
    <h1 id="anime-title">Loading...</h1>

    <div id="video-container">
      <video id="main-video" controls autoplay>
        <source id="video-source" src="" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>
    </div>

    <div>
      <h3>Choose Server</h3>
      <button onclick="loadAnimeHeaven()">AnimeHeaven</button>
      <button onclick="loadGogoAnime()">GogoAnime</button>
    </div>

    <div>
      <h3>Download Options</h3>
      <button onclick="downloadFromHeaven()">Download from AnimeHeaven</button>
      <button onclick="downloadFromTokyo()">Download from TokyoInsider</button>
      <button onclick="downloadFrom9anime()">Download from 9anime</button>
    </div>

    <div>
      <h3>Episodes</h3>
      <div class="episode-list" id="episode-list"></div>
    </div>
  </div>

  <script>
    const urlParts = window.location.pathname.split('/');
    const animeId = urlParts[2];
    const episodeNumber = parseInt(urlParts[3]);

    async function getAnimeDetails() {
      const query = `
        query {
          Media(id: ${animeId}, type: ANIME) {
            title { english romaji }
            episodes
          }
        }
      `;
      const res = await fetch("https://graphql.anilist.co", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      const json = await res.json();
      const anime = json.data.Media;
      const title = anime.title.english || anime.title.romaji;
      document.getElementById('anime-title').innerText = `${title} - Episode ${episodeNumber}`;
      return { title, episodes: anime.episodes };
    }

    async function loadAnimeHeaven() {
      const { title } = await getAnimeDetails();
      try {
        const res = await fetch(`http://txtorg-anih.hf.space/video?name=${encodeURIComponent(title)}&episode=${episodeNumber}`);
        const data = await res.json();
        const video = document.getElementById("main-video");
        video.src = data.videoUrl;
        video.load();
        video.play();
      } catch (e) {
        fallbackToIframe(`https://www31.gogoanimes.fi/${title.toLowerCase().replace(/\s/g, '-')}-episode-${episodeNumber}`);
      }
    }

    async function loadGogoAnime() {
      try {
        const { title } = await getAnimeDetails();
        const res = await fetch(`https://reikerxx-animedl.hf.space/anime/${encodeURIComponent(title)}/${episodeNumber}`);
        const data = await res.json();
        const streamUrl = `https://txtorg-anih.hf.space/iframe?url=${data.episodeUrl}`;
        const iframeRes = await fetch(streamUrl);
        const iframeData = await iframeRes.json();
        fallbackToIframe(iframeData.iframeUrl);
      } catch (e) {
        console.error("GogoAnime fallback failed", e);
      }
    }

    function fallbackToIframe(url) {
      const container = document.getElementById('video-container');
      container.innerHTML = `<iframe src="${url}" frameborder="0" allowfullscreen></iframe>`;
    }

    async function downloadFromHeaven() {
      const { title } = await getAnimeDetails();
      const res = await fetch(`http://txtorg-anih.hf.space/video?name=${encodeURIComponent(title)}&episode=${episodeNumber}`);
      const data = await res.json();
      const a = document.createElement("a");
      a.href = data.videoUrl;
      a.download = `Episode-${episodeNumber}.mp4`;
      a.click();
    }

    async function downloadFromTokyo() {
      const { title } = await getAnimeDetails();
      const res = await fetch(`https://reaperxxxx-anime.hf.space/api/anime2?name=${encodeURIComponent(title)}&episode=${episodeNumber}`);
      const data = await res.json();
      if (data.Downloads["720p"]) {
        window.open(data.Downloads["720p"].url, "_blank");
      } else if (data.Downloads["360p"]) {
        window.open(data.Downloads["360p"].url, "_blank");
      } else {
        alert("No available download.");
      }
    }

    async function downloadFrom9anime() {
      const { title } = await getAnimeDetails();
      const res = await fetch(`https://txtorg-anih.hf.space/api/anime-download?q=${encodeURIComponent(title)}&episode=${episodeNumber}`);
      const data = await res.json();
      if (data.download_links.length) {
        window.open(data.download_links[0].link, "_blank");
      } else {
        alert("No 9anime download links found.");
      }
    }

    async function renderEpisodeList(totalEpisodes) {
      const container = document.getElementById("episode-list");
      for (let i = 1; i <= totalEpisodes; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.onclick = () => {
          window.location.href = `/anime/${animeId}/${i}`;
        };
        container.appendChild(btn);
      }
    }

    (async () => {
      const details = await getAnimeDetails();
      await loadAnimeHeaven();
      await renderEpisodeList(details.episodes || 100); // fallback cap
    })();
  </script>
</body>
</html>
